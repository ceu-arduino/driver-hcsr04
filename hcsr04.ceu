#ifndef HCSR04_ECHO
#error Missing interrupt pin `HCSR04_ECHO`.
#endif
#ifndef HCSR04_TRIGGER
#error Missing output pin `HCSR04_TRIGGER`.
#endif

///////////////////////////////////////////////////////////////////////////////
// INTERFACE
///////////////////////////////////////////////////////////////////////////////

code/await Hcsr04 (none) -> int?;

///////////////////////////////////////////////////////////////////////////////
// IMPLEMENTATION
///////////////////////////////////////////////////////////////////////////////

#include "wclock.ceu"

code/await Hcsr04 (none) -> int? do
    emit HCSR04_TRIGGER(high);
    emit WCLOCK_FREEZE(10);
    emit HCSR04_TRIGGER(low);

    var int? ret;

    watching 25ms do
        await HCSR04_ECHO;
        var u32 old = _;
        emit WCLOCK_NOW(&old);
        await HCSR04_ECHO;
        var u32 now = _;
        emit WCLOCK_NOW(&now);
        ret = (((now - old) as int)/58) as int;
    end

    escape ret;
end
